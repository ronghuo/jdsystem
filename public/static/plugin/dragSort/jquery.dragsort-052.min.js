(function(a){a.fn.dragsort=function(c){if(c=="destroy"){a(this.selector).trigger("dragsort-uninit");return}var d=a.extend({},a.fn.dragsort.defaults,c);var b=[];var f=null,e=null;this.each(function(h,g){if(a(g).is("table")&&a(g).children().size()==1&&a(g).children().is("tbody")){g=a(g).children().get(0)}var j={draggedItem:null,placeHolderItem:null,pos:null,offset:null,offsetLimit:null,scroll:null,container:g,init:function(){d.tagName=a(this.container).children().size()==0?"li":a(this.container).children().get(0).tagName.toLowerCase();if(d.itemSelector==""){d.itemSelector=d.tagName}if(d.dragSelector==""){d.dragSelector=d.tagName}if(d.placeHolderTemplate==""){d.placeHolderTemplate="<"+d.tagName+">&nbsp;</"+d.tagName+">"}a(this.container).attr("data-listidx",h).mousedown(this.grabItem).bind("dragsort-uninit",this.uninit);this.styleDragHandlers(true)},uninit:function(){var i=b[a(this).attr("data-listidx")];a(i.container).unbind("mousedown",i.grabItem).unbind("dragsort-uninit");i.styleDragHandlers(false)},getItems:function(){return a(this.container).children(d.itemSelector)},styleDragHandlers:function(i){this.getItems().map(function(){return a(this).is(d.dragSelector)?this:a(this).find(d.dragSelector).get()}).css("cursor",i?"move":"pointer")},grabItem:function(p){var o=b[a(this).attr("data-listidx")];var n=a(p.target).closest("[data-listidx] > "+d.tagName).get(0);var k=o.getItems().filter(function(){return this==n}).size()>0;if(p.which!=1||a(p.target).is(d.dragSelectorExclude)||a(p.target).closest(d.dragSelectorExclude).size()>0||!k){return}p.preventDefault();var i=p.target;while(!a(i).is(d.dragSelector)){if(i==this){return}i=i.parentNode}a(i).attr("data-cursor",a(i).css("cursor"));a(i).css("cursor","move");var m=this;var l=function(){o.dragStart.call(m,p);a(o.container).unbind("mousemove",l)};a(o.container).mousemove(l).mouseup(function(){a(o.container).unbind("mousemove",l);a(i).css("cursor",a(i).attr("data-cursor"))})},dragStart:function(o){if(f!=null&&f.draggedItem!=null){f.dropItem()}f=b[a(this).attr("data-listidx")];f.draggedItem=a(o.target).closest("[data-listidx] > "+d.tagName);f.draggedItem.attr("data-origpos",a(this).attr("data-listidx")+"-"+a(f.container).children().index(f.draggedItem));var l=parseInt(f.draggedItem.css("marginTop"));var q=parseInt(f.draggedItem.css("marginLeft"));f.offset=f.draggedItem.offset();f.offset.top=o.pageY-f.offset.top+(isNaN(l)?0:l)-1;f.offset.left=o.pageX-f.offset.left+(isNaN(q)?0:q)-1;if(!d.dragBetween){var n=a(f.container).outerHeight()==0?Math.max(1,Math.round(0.5+f.getItems().size()*f.draggedItem.outerWidth()/a(f.container).outerWidth()))*f.draggedItem.outerHeight():a(f.container).outerHeight();f.offsetLimit=a(f.container).offset();f.offsetLimit.right=f.offsetLimit.left+a(f.container).outerWidth()-f.draggedItem.outerWidth();f.offsetLimit.bottom=f.offsetLimit.top+n-f.draggedItem.outerHeight()}var m=f.draggedItem.height();var k=f.draggedItem.width();if(d.tagName=="tr"){f.draggedItem.children().each(function(){a(this).width(a(this).width())});f.placeHolderItem=f.draggedItem.clone().attr("data-placeholder",true);f.draggedItem.after(f.placeHolderItem);f.placeHolderItem.children().each(function(){a(this).css({borderWidth:0,width:a(this).width()+1,height:a(this).height()+1}).html("&nbsp;")})}else{f.draggedItem.after(d.placeHolderTemplate);f.placeHolderItem=f.draggedItem.next().css({height:m,width:k}).attr("data-placeholder",true)}if(d.tagName=="td"){var i=f.draggedItem.closest("table").get(0);a("<table id='"+i.id+"' style='border-width: 0px;' class='dragSortItem "+i.className+"'><tr></tr></table>").appendTo("body").children().append(f.draggedItem)}var p=f.draggedItem.attr("style");f.draggedItem.attr("data-origstyle",p?p:"");f.draggedItem.css({position:"absolute",opacity:0.8,"z-index":999,height:m,width:k});f.scroll={moveX:0,moveY:0,maxX:a(document).width()-a(window).width(),maxY:a(document).height()-a(window).height()};f.scroll.scrollY=window.setInterval(function(){if(d.scrollContainer!=window){a(d.scrollContainer).scrollTop(a(d.scrollContainer).scrollTop()+f.scroll.moveY);return}var r=a(d.scrollContainer).scrollTop();if(f.scroll.moveY>0&&r<f.scroll.maxY||f.scroll.moveY<0&&r>0){a(d.scrollContainer).scrollTop(r+f.scroll.moveY);f.draggedItem.css("top",f.draggedItem.offset().top+f.scroll.moveY+1)}},10);f.scroll.scrollX=window.setInterval(function(){if(d.scrollContainer!=window){a(d.scrollContainer).scrollLeft(a(d.scrollContainer).scrollLeft()+f.scroll.moveX);return}var r=a(d.scrollContainer).scrollLeft();if(f.scroll.moveX>0&&r<f.scroll.maxX||f.scroll.moveX<0&&r>0){a(d.scrollContainer).scrollLeft(r+f.scroll.moveX);f.draggedItem.css("left",f.draggedItem.offset().left+f.scroll.moveX+1)}},10);a(b).each(function(s,r){r.createDropTargets();r.buildPositionTable()});f.setPos(o.pageX,o.pageY);a(document).bind("mousemove",f.swapItems);a(document).bind("mouseup",f.dropItem);if(d.scrollContainer!=window){a(window).bind("wheel",f.wheel)}},setPos:function(k,p){var n=p-this.offset.top;var m=k-this.offset.left;if(!d.dragBetween){n=Math.min(this.offsetLimit.bottom,Math.max(n,this.offsetLimit.top));m=Math.min(this.offsetLimit.right,Math.max(m,this.offsetLimit.left))}var l=this.draggedItem.offsetParent().not("body").offset();if(l!=null){n-=l.top;m-=l.left}if(d.scrollContainer==window){p-=a(window).scrollTop();k-=a(window).scrollLeft();p=Math.max(0,p-a(window).height()+5)+Math.min(0,p-5);k=Math.max(0,k-a(window).width()+5)+Math.min(0,k-5)}else{var i=a(d.scrollContainer);var o=i.offset();p=Math.max(0,p-i.height()-o.top)+Math.min(0,p-o.top);k=Math.max(0,k-i.width()-o.left)+Math.min(0,k-o.left)}f.scroll.moveX=k==0?0:k*d.scrollSpeed/Math.abs(k);f.scroll.moveY=p==0?0:p*d.scrollSpeed/Math.abs(p);this.draggedItem.css({top:n,left:m})},wheel:function(l){if(f&&d.scrollContainer!=window){var k=a(d.scrollContainer);var m=k.offset();l=l.originalEvent;if(l.clientX>m.left&&l.clientX<m.left+k.width()&&l.clientY>m.top&&l.clientY<m.top+k.height()){var i=(l.deltaMode==0?1:10)*l.deltaY;k.scrollTop(k.scrollTop()+i);l.preventDefault()}}},buildPositionTable:function(){var i=[];this.getItems().not([f.draggedItem[0],f.placeHolderItem[0]]).each(function(k){var l=a(this).offset();l.right=l.left+a(this).outerWidth();l.bottom=l.top+a(this).outerHeight();l.elm=this;i[k]=l});this.pos=i},dropItem:function(){if(f.draggedItem==null){return}var l=f.draggedItem.attr("data-origstyle");f.draggedItem.attr("style",l);if(l==""){f.draggedItem.removeAttr("style")}f.draggedItem.removeAttr("data-origstyle");f.styleDragHandlers(true);f.placeHolderItem.before(f.draggedItem);f.placeHolderItem.remove();a("[data-droptarget], .dragSortItem").remove();window.clearInterval(f.scroll.scrollY);window.clearInterval(f.scroll.scrollX);if(f.draggedItem.attr("data-origpos")!=a(b).index(f)+"-"+a(f.container).children().index(f.draggedItem)){if(d.dragEnd.apply(f.draggedItem)==false){var k=f.draggedItem.attr("data-origpos").split("-");var i=a(b[k[0]].container).children().not(f.draggedItem).eq(k[1]);if(i.size()>0){i.before(f.draggedItem)}else{if(k[1]==0){a(b[k[0]].container).prepend(f.draggedItem)}else{a(b[k[0]].container).append(f.draggedItem)}}}}f.draggedItem.removeAttr("data-origpos");f.draggedItem=null;a(document).unbind("mousemove",f.swapItems);a(document).unbind("mouseup",f.dropItem);if(d.scrollContainer!=window){a(window).unbind("wheel",f.wheel)}return false},swapItems:function(p){if(f.draggedItem==null){return false}f.setPos(p.pageX,p.pageY);var o=f.findPos(p.pageX,p.pageY);var n=f;for(var l=0;o==-1&&d.dragBetween&&l<b.length;l++){o=b[l].findPos(p.pageX,p.pageY);n=b[l]}if(o==-1){return false}var k=function(){return a(n.container).children().not(n.draggedItem)};var m=k().not(d.itemSelector).each(function(q){this.idx=k().index(this)});if(e==null||e.top>f.draggedItem.offset().top||e.left>f.draggedItem.offset().left){a(n.pos[o].elm).before(f.placeHolderItem)}else{a(n.pos[o].elm).after(f.placeHolderItem)}m.each(function(){var i=k().eq(this.idx).get(0);if(this!=i&&k().index(this)<this.idx){a(this).insertAfter(i)}else{if(this!=i){a(this).insertBefore(i)}}});a(b).each(function(r,q){q.createDropTargets();q.buildPositionTable()});e=f.draggedItem.offset();return false},findPos:function(k,m){for(var l=0;l<this.pos.length;l++){if(this.pos[l].left<k&&this.pos[l].right>k&&this.pos[l].top<m&&this.pos[l].bottom>m){return l}}return -1},createDropTargets:function(){if(!d.dragBetween){return}a(b).each(function(){var k=a(this.container).find("[data-placeholder]");var i=a(this.container).find("[data-droptarget]");if(k.size()>0&&i.size()>0){i.remove()}else{if(k.size()==0&&i.size()==0){if(d.tagName=="td"){a(d.placeHolderTemplate).attr("data-droptarget",true).appendTo(this.container)}else{a(this.container).append(f.placeHolderItem.removeAttr("data-placeholder").clone().attr("data-droptarget",true))}f.placeHolderItem.attr("data-placeholder",true)}}})}};j.init();b.push(j)});return this};a.fn.dragsort.defaults={itemSelector:"",dragSelector:"",dragSelectorExclude:"input, textarea",dragEnd:function(){},dragBetween:false,placeHolderTemplate:"",scrollContainer:window,scrollSpeed:5}})(jQuery);